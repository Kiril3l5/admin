import{d as l,a as w,R as m,b as g,U as k,I}from"./vendor-components-js-d6i_3.js";import{c as x,w as f,o as R,q as C,b as S,e as N,u as U,T as B,j as D,k as M,l as T,m as F}from"./vendor-firebase-q4K5YV9j.js";import{A as h,D as s,a as v}from"./vendor-utils-lm0uXl8i.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))t(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&t(o)}).observe(document,{childList:!0,subtree:!0});function r(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function t(a){if(a.ep)return;a.ep=!0;const n=r(a);fetch(a.href,n)}})();class z{constructor(e){if(!e)throw new Error("Container element is required");this.container=e,this.entries=[],this.initialized=!1,this.init()}async init(){try{this.updateLoadingState(!0),await this.loadEntries(),l.subscribe("timeEntriesTable",e=>{this.handleStateChange(e)}),this.render(),this.initialized=!0}catch(e){console.error("Failed to initialize time entries table:",e),this.showError("Failed to load time entries")}finally{this.updateLoadingState(!1)}}handleStateChange(e){const r=JSON.stringify({filters:e.filters,role:e.role});r!==this.lastStateKey&&this.shouldReload(e)&&(console.log("TimeEntriesTable: Role or filters changed"),this.lastStateKey=r,this.currentFilters=e.filters,this.currentRole=e.role,this.loadEntries())}shouldReload(e){return e.filters!==this.currentFilters||e.role!==this.currentRole}async loadEntries(){try{l.setLoading(!0),this.updateLoadingState(!0);const{role:e,user:r,assignedWorkers:t,filters:a}=l.getState();let n=x(w,"timeEntries");const o=[];e===m.ROLES.MANAGER&&t?.length>0&&o.push(f("workerId","in",t)),a.status&&a.status!=="all"&&o.push(f("status","==",a.status)),a.dateRange.startDate&&a.dateRange.endDate&&(o.push(f("date",">=",a.dateRange.startDate)),o.push(f("date","<=",a.dateRange.endDate))),o.push(R("date","desc"));const i=C(n,...o),d=await S(i);this.entries=d.docs.map(p=>({id:p.id,...p.data()}));const c=[...new Set(this.entries.map(p=>p.workerId).filter(p=>p&&typeof p=="string"))];if(c.length>0){const E=new Map;for(let u=0;u<c.length;u+=10){const A=c.slice(u,u+10),L=C(x(w,"users"),f("__name__","in",A));(await S(L)).forEach(b=>{E.set(b.id,{email:b.data().email,name:b.data().name})})}this.entries=this.entries.map(u=>({...u,workerEmail:E.get(u.workerId)?.email||u.workerEmail||"Unknown User",workerName:E.get(u.workerId)?.name||"Unknown"}))}this.render()}catch(e){console.error("Failed to load time entries:",e),h.showNotification("Failed to load time entries","error")}finally{l.setLoading(!1),this.updateLoadingState(!1)}}async render(){if(!this.container)throw new Error("Container not found");s.removeAllChildren(this.container);const e=this.createFiltersSection();this.container.appendChild(e);const r=this.groupEntriesByWeek(this.entries),t=s.createElement("div",{className:"space-y-6"});r.forEach((a,n)=>{const o=this.createWeekContainer(n,a);t.appendChild(o)}),this.container.appendChild(t)}createTableHeader(){const e=s.createElement("tr");return["Date","Worker","Hours","Type","Status","Actions"].forEach(t=>{const a=s.createElement("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",text:t});e.appendChild(a)}),e}createFiltersSection(){const{filters:e}=l.getState(),r=s.createElement("div",{className:"mb-6 p-4 bg-white rounded-lg shadow"}),t=s.createElement("select",{className:"mr-4 px-3 py-2 border rounded"});["All","Pending","Approved","Rejected"].forEach(d=>{const c=s.createElement("option",{text:d,value:d.toLowerCase(),attributes:{selected:e.status===d.toLowerCase()}});t.appendChild(c)});const a=s.createElement("div",{className:"flex items-center space-x-4"}),n=s.createElement("input",{className:"px-3 py-2 border rounded",attributes:{type:"date",value:e.dateRange.startDate?.toISOString().split("T")[0]||""}}),o=s.createElement("input",{className:"px-3 py-2 border rounded",attributes:{type:"date",value:e.dateRange.endDate?.toISOString().split("T")[0]||""}}),i=s.createElement("button",{className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",text:"Apply Filters"});return i.addEventListener("click",()=>{l.updateFilters({status:t.value,dateRange:{startDate:n.value?new Date(n.value):null,endDate:o.value?new Date(o.value):null}})}),a.append(n,o),r.append(t,a,i),r}renderEntries(){const e=this.container.querySelector("tbody");if(!e)return;s.removeAllChildren(e);const{user:r,settings:t}=l.getState();this.entries.forEach(a=>{const n=this.createEntryRow(a,r,t);e.appendChild(n)})}createEntryRow(e,r,t){const a=s.createElement("tr",{className:"hover:bg-gray-50"});a.appendChild(s.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:v.formatDate(new Date(e.date))})),a.appendChild(s.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:e.workerEmail||e.workerId})),a.appendChild(s.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:e.hours.toString()})),a.appendChild(s.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:e.type||"Regular"}));const n=s.createElement("td",{className:"px-6 py-4 whitespace-nowrap"}),o=s.createElement("span",{className:`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${this.getStatusBadgeClass(e.status)}`,text:e.status||"Pending"});n.appendChild(o),a.appendChild(n);const i=s.createElement("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium"});if(m.hasPermission(t,m.PERMISSIONS.APPROVE_TIME))if(e.status==="pending"){const d=s.createElement("button",{className:"text-green-600 hover:text-green-900 mr-4",text:"Approve"});d.addEventListener("click",()=>this.updateStatus(e.id,"approved"));const c=s.createElement("button",{className:"text-red-600 hover:text-red-900",text:"Reject"});c.addEventListener("click",()=>this.updateStatus(e.id,"rejected")),i.append(d,c)}else{const d=s.createElement("button",{className:"text-blue-600 hover:text-blue-900",text:"Reset Status"});d.addEventListener("click",()=>this.updateStatus(e.id,"pending")),i.appendChild(d)}return a.appendChild(i),a}async updateStatus(e,r){try{const{user:t}=l.getState(),a=N(w,"timeEntries",e);await U(a,{status:r,updatedAt:B.now(),updatedBy:t.uid}),await this.loadEntries(),h.showNotification(`Entry ${r} successfully`,"success")}catch(t){console.error("Error updating status:",t),h.showNotification("Failed to update entry status","error")}}getStatusBadgeClass(e){switch(e?.toLowerCase()){case"approved":return"bg-green-100 text-green-800";case"rejected":return"bg-red-100 text-red-800";default:return"bg-yellow-100 text-yellow-800"}}updateLoadingState(e){if(!this.container)return;const r=this.container.querySelector(".loading-overlay");if(e&&!r){const t=s.createElement("div",{className:"loading-overlay"}),a=s.createElement("div",{className:"spinner"});t.appendChild(a),this.container.appendChild(t)}else!e&&r&&r.remove()}groupEntriesByWeek(e){const r=new Map;return e.forEach(t=>{const a=new Date(t.date),n=v.formatDate(v.getWeekStart(a));r.has(n)||r.set(n,{entries:[],totals:{regularHours:0,overtimeHours:0,ptoHours:0}});const o=r.get(n);if(o.entries.push(t),t.isTimeOff)t.timeOffType==="paid"&&(o.totals.ptoHours+=t.hours||0);else{const i=t.hours||0;i>8?(o.totals.regularHours+=8,o.totals.overtimeHours+=i-8):o.totals.regularHours+=i}}),r}createWeekContainer(e,r){const t=s.createElement("div",{className:"bg-white rounded-lg shadow overflow-hidden"}),{week:a,year:n}=this.getWeekNumber(new Date(e)),o=s.createElement("div",{className:"p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50"}),i=s.createElement("h3",{className:"text-lg font-medium text-gray-900",text:`Week ${a}, ${n}`}),d=s.createElement("div",{className:"text-sm text-gray-600",text:`Regular: ${r.totals.regularHours}h | OT: ${r.totals.overtimeHours}h | PTO: ${r.totals.ptoHours}h`});o.append(i,d),t.appendChild(o);const c=this.createWeekTable(r.entries);return t.appendChild(c),t}createWeekTable(e){const r=s.createElement("div",{className:"overflow-x-auto"}),t=s.createElement("table",{className:"min-w-full divide-y divide-gray-200 table-fixed"}),a=s.createElement("thead",{className:"bg-gray-50"});a.appendChild(this.createTableHeader()),t.appendChild(a);const n=s.createElement("tbody",{className:"bg-white divide-y divide-gray-200"});return[...e].sort((i,d)=>new Date(d.date)-new Date(i.date)).forEach(i=>{const d=this.createEntryRow(i,l.getState().user,l.getState().settings);n.appendChild(d)}),t.appendChild(n),r.appendChild(t),r}getWeekNumber(e){const r=new Date(e),t=new Date(r.valueOf()),a=(r.getDay()+6)%7;t.setDate(t.getDate()-a+3);const n=new Date(t.getFullYear(),0,4);return{week:1+Math.ceil((t-n)/(7*24*60*60*1e3)),year:r.getFullYear()}}destroy(){l.unsubscribe("timeEntriesTable"),this.container=null,this.initialized=!1}}class O{constructor(){this.dashboardState=l,this.components={userManagement:null,timeEntriesTable:null,invoiceGenerator:null},this.initialize=this.initialize.bind(this),this.loadUserData=this.loadUserData.bind(this),this.renderDashboard=this.renderDashboard.bind(this)}async initialize(){try{console.log("Initializing AdminDashboard...");const e=g.currentUser;if(!e)throw console.error("No authenticated user"),new Error("No authenticated user");return await this.loadUserData(e.uid),await this.renderDashboard(),!0}catch(e){throw console.error("Failed to initialize dashboard:",e),e}}async loadUserData(e){try{console.log("Fetching user data for:",e);const r=await D(N(w,"users",e));if(!r.exists())throw console.error("No user document found"),new Error("User document not found");const t=r.data();this.dashboardState.setState({user:g.currentUser,role:t.role,assignedWorkers:t.assignedWorkers||[],settings:t.settings||{},isInitialized:!0}),console.log("User role loaded:",t.role)}catch(r){throw console.error("Error loading user data:",r),h.showNotification("Failed to load user data","error"),r}}async renderDashboard(){console.log("Rendering dashboard...");const e=document.getElementById("adminDashboard");if(!e)throw new Error("Admin dashboard container not found");e.style.display="block",s.removeAllChildren(e);const r=this.createHeader(),t=s.createElement("main",{className:"max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8"});e.appendChild(r),e.appendChild(t);const{role:a}=this.dashboardState.getState();console.log("Current user role:",a),m.hasAccess(a,[m.ROLES.SUPER_ADMIN,m.ROLES.MANAGER])&&await this.renderAdminSections(t)}createHeader(){const e=s.createElement("header",{className:"bg-white shadow mb-6"}),{user:r}=this.dashboardState.getState(),t=s.createElement("div",{className:"max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex justify-between items-center"}),a=s.createElement("h1",{text:`Welcome, ${r?.email}`,className:"text-3xl font-bold text-gray-900"}),n=s.createElement("button",{text:"Logout",className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"});return n.addEventListener("click",async()=>{try{await g.signOut(),window.location.reload()}catch(o){console.error("Error signing out:",o),h.showNotification("Failed to sign out","error")}}),t.append(a,n),e.appendChild(t),e}async renderAdminSections(e){try{console.log("Rendering admin sections...");const r=this.createSection("User Management","userManagementContent"),t=r.querySelector('[id="userManagementContent"]');t&&(this.components.userManagement=new k(t)),e.appendChild(r);const a=this.createSection("Time Entries","timeEntriesContent"),n=a.querySelector('[id="timeEntriesContent"]');n&&(this.components.timeEntriesTable=new z(n)),e.appendChild(a);const o=this.createSection("Invoice Generator","invoiceGeneratorContent"),i=o.querySelector('[id="invoiceGeneratorContent"]');if(i){const{companies:d=[]}=this.dashboardState.getState();this.components.invoiceGenerator=new I(d),this.components.invoiceGenerator.render(i)}e.appendChild(o)}catch(r){console.error("Error rendering admin sections:",r),h.showNotification("Failed to render dashboard sections","error")}}createSection(e,r){console.log(`Creating section: ${e}`);const t=s.createElement("div",{className:"bg-white shadow rounded-lg mb-6"}),a=s.createElement("div",{className:"px-4 py-5 border-b border-gray-200 sm:px-6"}),n=s.createElement("h2",{text:e,className:"text-lg font-medium text-gray-900"}),o=s.createElement("div",{attributes:{id:r},className:"px-4 py-5 sm:p-6 section-content"});return a.appendChild(n),t.appendChild(a),t.appendChild(o),t}getContentElements(e){return{userManagementContent:document.getElementById("userManagementContent"),timeEntriesContent:document.getElementById("timeEntriesContent"),invoiceGeneratorContent:document.getElementById("invoiceGeneratorContent")}}redirectToLogin(){console.warn("Redirecting to login..."),window.location.href="/"}showError(e){h.showNotification(e,"error")}}class P{constructor(){this.initialized=!1,this.setupAuthListener()}setupAuthListener(){M(g,async e=>{console.log("Auth: ",e?"User authenticated":"No user");const r=document.getElementById("appLoading"),t=document.getElementById("authContainer"),a=document.getElementById("adminDashboard");if(r&&(r.style.display="none",console.log("Loading screen hidden")),e)try{if(console.log("Loading user data..."),!await this.loadUserData(e))throw new Error("No user data found");t&&(t.classList.remove("active"),t.style.display="none"),a&&(a.style.display="block")}catch(n){console.error("Error loading user data:",n),await this.logout()}else t&&(t.style.display="block",t.classList.add("active")),a&&(a.style.display="none"),console.log("No user, showing login form")})}async login(e,r){try{console.log("Attempting login...");const t=await T(g,e,r);console.log("Firebase Auth successful, loading user data...");const a=await this.loadUserData(t.user);if(!a)throw console.error("No user data found"),new Error("No user data found");if(console.log("Verifying admin access...",a.role),!this.verifyAdminAccess(a.role))throw console.error("User does not have admin access"),await this.logout(),new Error("Unauthorized access. Admin privileges required.");return console.log("Login successful!"),a}catch(t){console.error("Login error:",t);const a=this.getLoginErrorMessage(t);throw h.showNotification(a,"error"),t}}async loadUserData(e){try{let r=null;const t=N(w,"users",e.uid),a=await D(t);if(a.exists())r={id:a.id,...a.data()};else{const n=x(w,"users"),o=C(n,f("email","==",e.email)),i=await S(o);i.empty||(r={id:i.docs[0].id,...i.docs[0].data()})}if(!r)throw new Error("User data not found");return l.updateUserData({user:e,role:r.role,assignedWorkers:r.assignedWorkers||[],settings:r.settings||m.getDefaultPermissions(r.role)}),this.updateUIForAuthenticatedUser(e.email),r}catch(r){throw console.error("Error loading user data:",r),r}}verifyAdminAccess(e){return[m.ROLES.SUPER_ADMIN,m.ROLES.MANAGER].includes(e)}async logout(){try{await F(g),l.reset(),this.redirectToLogin()}catch(e){console.error("Logout error:",e),h.showNotification("Failed to logout. Please try again.","error")}}updateUIForAuthenticatedUser(e){const r=document.getElementById("authContainer"),t=document.getElementById("adminDashboard"),a=document.getElementById("adminEmail");r&&r.classList.remove("active"),t&&(t.style.display="block"),a&&(a.textContent=e)}getLoginErrorMessage(e){switch(e.code){case"auth/invalid-email":return"Invalid email address format.";case"auth/user-disabled":return"This account has been disabled. Please contact support.";case"auth/user-not-found":return"No account found with this email.";case"auth/wrong-password":return"Invalid password.";case"auth/too-many-requests":return"Too many failed attempts. Please try again later.";default:return e.message||"An error occurred during login."}}redirectToLogin(){console.warn("Redirecting to login..."),window.location.href="./"}async verifySession(){const e=g.currentUser;if(!e)return!1;try{return await e.getIdToken(!0),!0}catch(r){return console.error("Session verification failed:",r),!1}}getAuthStatus(){const{user:e,role:r,isInitialized:t}=l.getState();return{isAuthenticated:!!e,isAdmin:this.verifyAdminAccess(r),isInitialized:t,user:e}}}if(!l)throw console.error("DashboardState not initialized"),new Error("DashboardState not initialized");class W{constructor(){this.adminDashboard=null,this.authManager=new P}async initialize(){try{console.log("Initializing Admin App..."),this.setupEventListeners(),this.setupAuthStateListener(),this.setupErrorHandling()}catch(e){console.error("Failed to initialize admin app:",e),this.showError("Application initialization failed.")}}setupAuthStateListener(){g.onAuthStateChanged(async e=>{console.log("Auth state changed:",e?"User authenticated":"No user");const r=document.getElementById("appLoading"),t=document.getElementById("authContainer"),a=document.getElementById("adminDashboard");r&&(r.style.display="none"),e?(console.log("User authenticated:",e.email),t&&(t.style.display="none"),a&&(a.style.display="block"),await this.initializeDashboard(e)):(console.log("No user, showing login form"),t&&(t.style.display="block"),a&&(a.style.display="none"))})}setupEventListeners(){const e=document.getElementById("loginForm");e&&e.addEventListener("submit",async t=>{t.preventDefault();const a=document.getElementById("email").value,n=document.getElementById("password").value;try{await this.authManager.login(a,n)}catch{}});const r=document.getElementById("logoutBtn");r&&r.addEventListener("click",()=>this.authManager.logout())}async initializeDashboard(e){try{this.adminDashboard=new O,await this.adminDashboard.initialize()}catch(r){console.error("Failed to initialize dashboard:",r),this.showError("Failed to initialize dashboard.")}}setupErrorHandling(){window.addEventListener("unhandledrejection",e=>{console.error("Unhandled promise rejection:",e.reason),this.showError("An unexpected error occurred.")}),window.addEventListener("error",e=>{console.error("Global error:",e.error),this.showError("An unexpected error occurred.")})}showError(e){const r=document.getElementById("errorBoundary"),t=document.getElementById("errorMessage");r&&t&&(r.style.display="flex",t.textContent=e)}}document.addEventListener("DOMContentLoaded",()=>{new W().initialize()});
