import{d as u,a as f,R as m,b as g,U as A,I as L}from"./vendor-components-CVJ8IrUm.js";import{c as y,w as E,o as I,q as b,b as v,e as x,T as C,h as R,u as T,j as S,k as H,l as M,m as U}from"./vendor-firebase-q4K5YV9j.js";import{a as p,A as h,D as r}from"./vendor-utils-lm0uXl8i.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&a(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();class B{constructor(e){if(!e)throw new Error("Container element is required");this.container=e,this.entries=[],this.initialized=!1,this.init()}async init(){try{this.updateLoadingState(!0),await this.loadEntries(),u.subscribe("timeEntriesTable",e=>{this.handleStateChange(e)}),this.render(),this.initialized=!0}catch(e){console.error("Failed to initialize time entries table:",e),this.showError("Failed to load time entries")}finally{this.updateLoadingState(!1)}}handleStateChange(e){const t=JSON.stringify({filters:e.filters,role:e.role});t!==this.lastStateKey&&(console.log("Filters changed:",e.filters),this.lastStateKey=t,this.currentFilters=e.filters,this.currentRole=e.role,this.loadEntries())}shouldReload(e){return e.filters!==this.currentFilters||e.role!==this.currentRole}async loadEntries(){try{const{role:e,filters:t}=u.getState();console.log("Current filters:",t);let a=y(f,"timeEntries");const s=[];if(t.status&&t.status.toLowerCase()!=="all"){const i=t.status.toLowerCase();console.log("Adding status filter:",i),s.push(E("status","==",i))}if(t.dateRange.startDate&&t.dateRange.endDate){const i=p.formatDate(new Date(t.dateRange.startDate)),c=p.formatDate(new Date(t.dateRange.endDate));s.push(E("date",">=",i)),s.push(E("date","<=",c))}s.push(I("date","desc"));const o=b(a,...s),n=await v(o);console.log("Query returned entries:",n.size);let l=n.docs.map(i=>({id:i.id,...i.data()}));if(l.length>0){const i=[...new Set(l.map(d=>d.userId))],c={};for(let d=0;d<i.length;d+=10){const D=i.slice(d,d+10),k=b(y(f,"users"),E("__name__","in",D));(await v(k)).forEach(N=>{c[N.id]=N.data().email})}l=l.map(d=>({...d,workerEmail:c[d.userId]||"Unknown"}))}this.entries=l,this.render()}catch(e){console.error("Failed to load time entries:",e),h.showNotification("Failed to load time entries","error")}finally{u.setLoading(!1),this.updateLoadingState(!1)}}async render(){if(!this.container)throw new Error("Container not found");if(r.removeAllChildren(this.container),this.container.appendChild(this.createDashboardSummary()),this.container.appendChild(this.createFiltersSection()),console.log("Number of entries to render:",this.entries.length),this.entries.length===0){const a=r.createElement("div",{className:"text-center p-8 bg-white rounded-lg shadow",text:"No time entries found for the selected filters."});this.container.appendChild(a);return}const e=this.groupEntriesByWeekAndUser();if(console.log("Weekly data to render:",e),e.length===0){const a=r.createElement("div",{className:"text-center p-8 bg-white rounded-lg shadow",text:"No entries grouped by week found."});this.container.appendChild(a);return}const t=this.createWeeklySummary(e);this.container.appendChild(t)}createTableHeader(){const e=r.createElement("tr");return["Date","Worker","Hours","Type","Status","Actions"].forEach(a=>{const s=r.createElement("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",text:a});e.appendChild(s)}),e}createFiltersSection(){const{filters:e}=u.getState();console.log("Current filter state:",e);const t=r.createElement("div",{className:"mb-6 p-4 bg-white rounded-lg shadow"}),a=r.createElement("select",{className:"mr-4 px-3 py-2 border rounded"});[{value:"all",text:"All"},{value:"pending",text:"Pending"},{value:"approved",text:"Approved"},{value:"rejected",text:"Rejected"}].forEach(({value:i,text:c})=>{const d=r.createElement("option",{text:c,value:i,attributes:{selected:e.status?.toLowerCase()===i}});a.appendChild(d)});const s=r.createElement("div",{className:"flex items-center space-x-4"}),o=r.createElement("input",{className:"px-3 py-2 border rounded",attributes:{type:"date",value:e.dateRange.startDate?new Date(e.dateRange.startDate).toISOString().split("T")[0]:""}}),n=r.createElement("input",{className:"px-3 py-2 border rounded",attributes:{type:"date",value:e.dateRange.endDate?new Date(e.dateRange.endDate).toISOString().split("T")[0]:""}}),l=r.createElement("button",{className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",text:"Apply Filters"});return l.addEventListener("click",()=>{const i={status:a.value.toLowerCase(),dateRange:{startDate:o.value?new Date(o.value):null,endDate:n.value?new Date(n.value):null}};console.log("Applying new filters:",i),u.updateFilters(i)}),s.append(o,n),t.append(a,s,l),t}renderEntries(){const e=this.container.querySelector("tbody");if(!e)return;r.removeAllChildren(e);const{user:t,settings:a}=u.getState();this.entries.forEach(s=>{const o=this.createEntryRow(s,t,a);e.appendChild(o)})}createEntryRow(e,t,a){console.log("Creating row with settings:",a);const s=r.createElement("tr",{className:"hover:bg-gray-50"});s.appendChild(r.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:p.formatDate(new Date(e.date))})),s.appendChild(r.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:e.workerEmail||e.userId})),s.appendChild(r.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:e.hours.toString()})),s.appendChild(r.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:e.type||"Regular"}));const o=r.createElement("td",{className:"px-6 py-4 whitespace-nowrap"}),n=r.createElement("span",{className:`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${this.getStatusBadgeClass(e.status)}`,text:e.status?e.status.charAt(0).toUpperCase()+e.status.slice(1):"Pending"});o.appendChild(n),s.appendChild(o);const l=r.createElement("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium"}),i=m.hasPermission(a,m.PERMISSIONS.APPROVE_TIME);if(console.log("Permission check:",{hasPermission:i,settings:a,permission:m.PERMISSIONS.APPROVE_TIME,status:e.status}),i&&(!e.status||e.status==="pending")){const c=r.createElement("button",{className:"text-green-600 hover:text-green-900 mr-4",text:"Approve"});c.addEventListener("click",()=>this.updateStatus(e.id,"approved"));const d=r.createElement("button",{className:"text-red-600 hover:text-red-900",text:"Reject"});d.addEventListener("click",()=>this.updateStatus(e.id,"rejected")),l.append(c,d)}return s.appendChild(l),s}async updateStatus(e,t){try{const{user:a}=u.getState(),s=x(f,"timeEntries",e),o={status:t,updatedAt:C.now(),updatedBy:a.uid,history:R({status:t,timestamp:C.now(),userId:a.uid})};await T(s,o),await this.loadEntries(),h.showNotification(`Time entry ${t} successfully`,"success")}catch(a){console.error("Error updating status:",a),h.showNotification("Failed to update status","error")}}getStatusBadgeClass(e){switch(e?.toLowerCase()){case"approved":return"bg-green-100 text-green-800";case"pending":return"bg-yellow-100 text-yellow-800";case"rejected":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}}updateLoadingState(e){if(!this.container)return;const t=this.container.querySelector(".loading-overlay");if(e&&!t){const a=r.createElement("div",{className:"loading-overlay"}),s=r.createElement("div",{className:"spinner"});a.appendChild(s),this.container.appendChild(a)}else!e&&t&&t.remove()}groupEntriesByWeek(e){const t=new Map;return e.forEach(a=>{const s=new Date(a.date),o=p.formatDate(p.getWeekStart(s));t.has(o)||t.set(o,{entries:[],totals:{regularHours:0,overtimeHours:0,ptoHours:0,pending:0,approved:0,rejected:0}});const n=t.get(o);if(n.entries.push(a),n.totals[a.status]=(n.totals[a.status]||0)+1,a.isTimeOff)a.timeOffType==="paid"&&(n.totals.ptoHours+=a.hours||0);else{const l=a.hours||0;l>8?(n.totals.regularHours+=8,n.totals.overtimeHours+=l-8):n.totals.regularHours+=l}}),t}createWeekContainer(e,t){const a=r.createElement("div",{className:"bg-white rounded-lg shadow overflow-hidden"}),{week:s,year:o}=this.getWeekNumber(new Date(e)),n=r.createElement("div",{className:"p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50"}),l=r.createElement("h3",{className:"text-lg font-medium text-gray-900",text:`Week ${s}, ${o}`}),i=r.createElement("div",{className:"text-sm text-gray-600",text:`Regular: ${t.totals.regularHours}h | OT: ${t.totals.overtimeHours}h | PTO: ${t.totals.ptoHours}h`});n.append(l,i),a.appendChild(n);const c=this.createWeekTable(t.entries);return a.appendChild(c),a}createWeekTable(e){const t=r.createElement("div",{className:"overflow-x-auto"}),a=r.createElement("table",{className:"min-w-full divide-y divide-gray-200 table-fixed"}),s=r.createElement("thead",{className:"bg-gray-50"});s.appendChild(this.createTableHeader()),a.appendChild(s);const o=r.createElement("tbody",{className:"bg-white divide-y divide-gray-200"});return[...e].sort((l,i)=>new Date(i.date)-new Date(l.date)).forEach(l=>{const i=this.createEntryRow(l,u.getState().user,u.getState().settings);o.appendChild(i)}),a.appendChild(o),t.appendChild(a),t}getWeekNumber(e){const t=new Date(e);t.setHours(0,0,0,0);const a=new Date(t.getFullYear(),0,1),s=new Date(a);if(s.setDate(a.getDate()+(7-a.getDay())%7),t<s)return{week:1,year:t.getFullYear()};const o=Math.floor((t-s)/(24*60*60*1e3));return{week:Math.floor(o/7)+2,year:t.getFullYear()}}createDashboardSummary(){const e=r.createElement("div",{className:"grid grid-cols-4 gap-4 mb-6"}),t={pending:this.entries.filter(s=>s.status==="pending").length,approved:this.entries.filter(s=>s.status==="approved").length,rejected:this.entries.filter(s=>s.status==="rejected").length,total:this.entries.length};return[{title:"Pending Approval",value:t.pending,color:"yellow",urgent:t.pending>0},{title:"Approved",value:t.approved,color:"green"},{title:"Rejected",value:t.rejected,color:"red"},{title:"Total Entries",value:t.total,color:"blue"}].forEach(s=>{const o=r.createElement("div",{className:`p-4 bg-white rounded-lg border-l-4 border-${s.color}-500 shadow`}),n=r.createElement("h3",{className:"text-sm font-medium text-gray-500",text:s.title}),l=r.createElement("p",{className:`mt-1 text-3xl font-semibold ${s.urgent?"text-red-600":"text-gray-900"}`,text:s.value.toString()});o.append(n,l),e.appendChild(o)}),e}createWeeklySummary(e){console.log("Creating weekly summary for data:",e);const t=p.getWeekStart(new Date),a=r.createElement("div",{className:"space-y-6"}),s=e.filter(o=>o.weekStart<=t);return console.log("Filtered weeks:",s),s.forEach(o=>{const n=r.createElement("div",{className:"bg-white rounded-lg shadow"}),l=r.createElement("div",{className:"px-4 py-3 border-b border-gray-200 bg-gray-50"});l.appendChild(r.createElement("h3",{className:"text-lg font-medium",text:`Week of ${p.formatDate(o.weekStart)}`})),n.appendChild(l);const i=r.createElement("div",{className:"divide-y divide-gray-200"});console.log("Users for week:",o.users),o.users.forEach(c=>{i.appendChild(this.createUserSummaryRow(c))}),n.appendChild(i),a.appendChild(n)}),a}createUserSummaryRow(e){return r.createElement("div",{className:"p-4 hover:bg-gray-50 cursor-pointer border-b",onClick:()=>this.showDetailedView(e)},[r.createElement("div",{className:"flex justify-between items-center"},[r.createElement("div",{className:"flex-1"},[r.createElement("p",{className:"font-medium",text:e.workerEmail}),r.createElement("div",{className:"text-sm text-gray-500",text:`Regular: ${e.regularHours}h | OT: ${e.overtimeHours}h | PTO: ${e.ptoHours}h | Unpaid: ${e.unpaidHours}h`})]),r.createElement("span",{className:`px-2 py-1 text-sm rounded-full ${this.getStatusBadgeClass(e.status)}`,text:e.status})])])}showDetailedView(e){const t=this.createDetailedView({...e,weekStart:p.getWeekStart(new Date(e.entries[0].date))});document.body.appendChild(t)}createActionCell(e){const t=r.createElement("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium"}),{settings:a}=u.getState();if(m.hasPermission(a,m.PERMISSIONS.APPROVE_TIME)&&(!e.status||e.status==="pending")){const o=r.createElement("button",{className:"text-green-600 hover:text-green-900 mr-4",text:"Approve"});o.addEventListener("click",()=>this.updateStatus(e.id,"approved"));const n=r.createElement("button",{className:"text-red-600 hover:text-red-900",text:"Reject"});n.addEventListener("click",()=>this.updateStatus(e.id,"rejected")),t.append(o,n)}return t}createDetailedView(e){return r.createElement("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full",id:"detailedView"},[r.createElement("div",{className:"relative top-20 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white"},[r.createElement("div",{className:"flex justify-between items-center mb-4"},[r.createElement("h3",{className:"text-lg font-medium",text:`${e.workerEmail} - Week of ${p.formatDate(e.weekStart)}`}),r.createElement("button",{className:"text-gray-500 hover:text-gray-700",onClick:()=>this.closeDetailedView(),text:"Ã—"})]),this.createDailyEntriesTable(e.entries),r.createElement("div",{className:"mt-4 flex justify-end space-x-3"},[r.createElement("button",{className:"px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600",onClick:()=>this.approveWeek(e),text:"Approve All"}),r.createElement("button",{className:"px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600",onClick:()=>this.rejectWeek(e),text:"Reject All"})])])])}groupEntriesByWeekAndUser(){console.log("Starting to group entries:",this.entries.length);const e=new Map;this.entries.forEach(a=>{const s=p.getWeekStart(new Date(a.date)),o=p.formatDate(s),n=a.userId;e.has(o)||e.set(o,{weekStart:s,users:new Map,totals:{regularHours:0,overtimeHours:0,ptoHours:0,unpaidHours:0}});const l=e.get(o);l.users.has(n)||l.users.set(n,{userId:n,workerEmail:a.workerEmail,weekStart:s,entries:[],totals:{regularHours:0,overtimeHours:0,ptoHours:0,unpaidHours:0},status:a.status||"pending"});const i=l.users.get(n);if(i.entries.push(a),a.isTimeOff)a.timeOffType==="paid"?(i.totals.ptoHours+=a.hours||0,l.totals.ptoHours+=a.hours||0):(i.totals.unpaidHours+=a.hours||0,l.totals.unpaidHours+=a.hours||0);else{const c=Math.min(a.hours||0,8),d=Math.max((a.hours||0)-8,0);i.totals.regularHours+=c,i.totals.overtimeHours+=d,l.totals.regularHours+=c,l.totals.overtimeHours+=d}a.status==="rejected"?i.status="rejected":a.status==="pending"&&i.status!=="rejected"?i.status="pending":a.status==="approved"&&i.status!=="rejected"&&i.status!=="pending"&&(i.status="approved")});const t=Array.from(e.entries()).map(([a,s])=>({...s,users:Array.from(s.users.values()).sort((o,n)=>n.weekStart-o.weekStart)})).sort((a,s)=>s.weekStart-a.weekStart);return console.log("Grouped data:",t),t}createDailyEntriesTable(e){const t=r.createElement("table",{className:"min-w-full divide-y divide-gray-200"}),a=r.createElement("thead",{className:"bg-gray-50"});a.appendChild(r.createElement("tr",{},["Date","Hours","Type","Status","Actions"].map(o=>r.createElement("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",text:o}))));const s=r.createElement("tbody",{className:"bg-white divide-y divide-gray-200"});return e.sort((o,n)=>new Date(o.date)-new Date(n.date)).forEach(o=>{const n=r.createElement("tr",{className:"hover:bg-gray-50"});n.appendChild(r.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:p.formatDate(new Date(o.date))})),n.appendChild(r.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:this.formatHours(o)})),n.appendChild(r.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:this.getEntryType(o)})),n.appendChild(r.createElement("td",{className:"px-6 py-4 whitespace-nowrap"},[r.createElement("span",{className:`px-2 py-1 text-sm rounded-full ${this.getStatusBadgeClass(o.status)}`,text:o.status||"pending"})])),n.appendChild(this.createActionCell(o)),s.appendChild(n)}),t.append(a,s),t}formatHours(e){if(e.isTimeOff)return`${e.hours}h (${e.timeOffType})`;const t=Math.min(e.hours||0,8),a=Math.max((e.hours||0)-8,0);return a>0?`${t}h + ${a}h OT`:`${t}h`}getEntryType(e){return e.isTimeOff?`Time Off (${e.timeOffType})`:e.overtimeHours>0?"Regular + OT":"Regular"}async approveWeek(e){try{await Promise.all(e.entries.filter(t=>t.status==="pending").map(t=>this.updateStatus(t.id,"approved"))),this.closeDetailedView(),h.showNotification("Week approved successfully","success")}catch(t){console.error("Error approving week:",t),h.showNotification("Failed to approve week","error")}}async rejectWeek(e){try{await Promise.all(e.entries.filter(t=>t.status==="pending").map(t=>this.updateStatus(t.id,"rejected"))),this.closeDetailedView(),h.showNotification("Week rejected successfully","success")}catch(t){console.error("Error rejecting week:",t),h.showNotification("Failed to reject week","error")}}closeDetailedView(){const e=document.getElementById("detailedView");e&&e.remove()}destroy(){u.unsubscribe("timeEntriesTable"),this.container=null,this.initialized=!1}}class O{constructor(){this.dashboardState=u,this.components={userManagement:null,timeEntriesTable:null,invoiceGenerator:null},this.initialize=this.initialize.bind(this),this.loadUserData=this.loadUserData.bind(this),this.renderDashboard=this.renderDashboard.bind(this)}async initialize(){try{console.log("Initializing AdminDashboard...");const e=g.currentUser;if(!e)throw console.error("No authenticated user"),new Error("No authenticated user");return await this.loadUserData(e.uid),await this.renderDashboard(),!0}catch(e){throw console.error("Failed to initialize dashboard:",e),e}}async loadUserData(e){try{console.log("Fetching user data for:",e);const t=await S(x(f,"users",e));if(!t.exists())throw console.error("No user document found"),new Error("User document not found");const a=t.data(),s=a.permissions||m.getDefaultPermissions(a.role);this.dashboardState.setState({user:g.currentUser,role:a.role,assignedWorkers:a.assignedWorkers||[],settings:s,isInitialized:!0}),console.log("User role and settings loaded:",{role:a.role,settings:s})}catch(t){throw console.error("Error loading user data:",t),h.showNotification("Failed to load user data","error"),t}}async renderDashboard(){console.log("Rendering dashboard...");const e=document.getElementById("adminDashboard");if(!e)throw new Error("Admin dashboard container not found");e.style.display="block",r.removeAllChildren(e);const t=this.createHeader(),a=r.createElement("main",{className:"max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8"});e.appendChild(t),e.appendChild(a);const{role:s}=this.dashboardState.getState();console.log("Current user role:",s),m.hasAccess(s,[m.ROLES.SUPER_ADMIN,m.ROLES.MANAGER])&&await this.renderAdminSections(a)}createHeader(){const e=r.createElement("header",{className:"bg-white shadow mb-6"}),{user:t}=this.dashboardState.getState(),a=r.createElement("div",{className:"max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex justify-between items-center"}),s=r.createElement("h1",{text:`Welcome, ${t?.email}`,className:"text-3xl font-bold text-gray-900"}),o=r.createElement("button",{text:"Logout",className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"});return o.addEventListener("click",async()=>{try{await g.signOut(),window.location.reload()}catch(n){console.error("Error signing out:",n),h.showNotification("Failed to sign out","error")}}),a.append(s,o),e.appendChild(a),e}async renderAdminSections(e){try{console.log("Rendering admin sections...");const t=this.createSection("User Management","userManagementContent"),a=t.querySelector('[id="userManagementContent"]');a&&(this.components.userManagement=new A(a)),e.appendChild(t);const s=this.createSection("Time Entries","timeEntriesContent"),o=s.querySelector('[id="timeEntriesContent"]');o&&(this.components.timeEntriesTable=new B(o)),e.appendChild(s);const n=this.createSection("Invoice Generator","invoiceGeneratorContent"),l=n.querySelector('[id="invoiceGeneratorContent"]');if(l){const{companies:i=[]}=this.dashboardState.getState();this.components.invoiceGenerator=new L(i),this.components.invoiceGenerator.render(l)}e.appendChild(n)}catch(t){console.error("Error rendering admin sections:",t),h.showNotification("Failed to render dashboard sections","error")}}createSection(e,t){console.log(`Creating section: ${e}`);const a=r.createElement("div",{className:"bg-white shadow rounded-lg mb-6"}),s=r.createElement("div",{className:"px-4 py-5 border-b border-gray-200 sm:px-6"}),o=r.createElement("h2",{text:e,className:"text-lg font-medium text-gray-900"}),n=r.createElement("div",{attributes:{id:t},className:"px-4 py-5 sm:p-6 section-content"});return s.appendChild(o),a.appendChild(s),a.appendChild(n),a}getContentElements(e){return{userManagementContent:document.getElementById("userManagementContent"),timeEntriesContent:document.getElementById("timeEntriesContent"),invoiceGeneratorContent:document.getElementById("invoiceGeneratorContent")}}redirectToLogin(){console.warn("Redirecting to login..."),window.location.href="/"}showError(e){h.showNotification(e,"error")}}class F{constructor(){this.initialized=!1,this.setupAuthListener()}setupAuthListener(){H(g,async e=>{console.log("Auth: ",e?"User authenticated":"No user");const t=document.getElementById("appLoading"),a=document.getElementById("authContainer"),s=document.getElementById("adminDashboard");if(t&&(t.style.display="none",console.log("Loading screen hidden")),e)try{if(console.log("Loading user data..."),!await this.loadUserData(e))throw new Error("No user data found");a&&(a.classList.remove("active"),a.style.display="none"),s&&(s.style.display="block")}catch(o){console.error("Error loading user data:",o),await this.logout()}else a&&(a.style.display="block",a.classList.add("active")),s&&(s.style.display="none"),console.log("No user, showing login form")})}async login(e,t){try{console.log("Attempting login...");const a=await M(g,e,t);console.log("Firebase Auth successful, loading user data...");const s=await this.loadUserData(a.user);if(!s)throw console.error("No user data found"),new Error("No user data found");if(console.log("Verifying admin access...",s.role),!this.verifyAdminAccess(s.role))throw console.error("User does not have admin access"),await this.logout(),new Error("Unauthorized access. Admin privileges required.");return console.log("Login successful!"),s}catch(a){console.error("Login error:",a);const s=this.getLoginErrorMessage(a);throw h.showNotification(s,"error"),a}}async loadUserData(e){try{let t=null;const a=x(f,"users",e.uid),s=await S(a);if(s.exists())t={id:s.id,...s.data()};else{const o=y(f,"users"),n=b(o,E("email","==",e.email)),l=await v(n);l.empty||(t={id:l.docs[0].id,...l.docs[0].data()})}if(!t)throw new Error("User data not found");return u.updateUserData({user:e,role:t.role,assignedWorkers:t.assignedWorkers||[],settings:t.settings||m.getDefaultPermissions(t.role)}),this.updateUIForAuthenticatedUser(e.email),t}catch(t){throw console.error("Error loading user data:",t),t}}verifyAdminAccess(e){return[m.ROLES.SUPER_ADMIN,m.ROLES.MANAGER].includes(e)}async logout(){try{await U(g),u.reset(),this.redirectToLogin()}catch(e){console.error("Logout error:",e),h.showNotification("Failed to logout. Please try again.","error")}}updateUIForAuthenticatedUser(e){const t=document.getElementById("authContainer"),a=document.getElementById("adminDashboard"),s=document.getElementById("adminEmail");t&&t.classList.remove("active"),a&&(a.style.display="block"),s&&(s.textContent=e)}getLoginErrorMessage(e){switch(e.code){case"auth/invalid-email":return"Invalid email address format.";case"auth/user-disabled":return"This account has been disabled. Please contact support.";case"auth/user-not-found":return"No account found with this email.";case"auth/wrong-password":return"Invalid password.";case"auth/too-many-requests":return"Too many failed attempts. Please try again later.";default:return e.message||"An error occurred during login."}}redirectToLogin(){console.warn("Redirecting to login..."),window.location.href="./"}async verifySession(){const e=g.currentUser;if(!e)return!1;try{return await e.getIdToken(!0),!0}catch(t){return console.error("Session verification failed:",t),!1}}getAuthStatus(){const{user:e,role:t,isInitialized:a}=u.getState();return{isAuthenticated:!!e,isAdmin:this.verifyAdminAccess(t),isInitialized:a,user:e}}}if(!u)throw console.error("DashboardState not initialized"),new Error("DashboardState not initialized");class j{constructor(){this.adminDashboard=null,this.authManager=new F}async initialize(){try{console.log("Initializing Admin App..."),this.setupEventListeners(),this.setupAuthStateListener(),this.setupErrorHandling()}catch(e){console.error("Failed to initialize admin app:",e),this.showError("Application initialization failed.")}}setupAuthStateListener(){g.onAuthStateChanged(async e=>{console.log("Auth state changed:",e?"User authenticated":"No user");const t=document.getElementById("appLoading"),a=document.getElementById("authContainer"),s=document.getElementById("adminDashboard");t&&(t.style.display="none"),e?(console.log("User authenticated:",e.email),a&&(a.style.display="none"),s&&(s.style.display="block"),await this.initializeDashboard(e)):(console.log("No user, showing login form"),a&&(a.style.display="block"),s&&(s.style.display="none"))})}setupEventListeners(){const e=document.getElementById("loginForm");e&&e.addEventListener("submit",async a=>{a.preventDefault();const s=document.getElementById("email").value,o=document.getElementById("password").value;try{await this.authManager.login(s,o)}catch{}});const t=document.getElementById("logoutBtn");t&&t.addEventListener("click",()=>this.authManager.logout())}async initializeDashboard(e){try{this.adminDashboard=new O,await this.adminDashboard.initialize()}catch(t){console.error("Failed to initialize dashboard:",t),this.showError("Failed to initialize dashboard.")}}setupErrorHandling(){window.addEventListener("unhandledrejection",e=>{console.error("Unhandled promise rejection:",e.reason),this.showError("An unexpected error occurred.")}),window.addEventListener("error",e=>{console.error("Global error:",e.error),this.showError("An unexpected error occurred.")})}showError(e){const t=document.getElementById("errorBoundary"),a=document.getElementById("errorMessage");t&&a&&(t.style.display="flex",a.textContent=e)}}document.addEventListener("DOMContentLoaded",()=>{new j().initialize()});
