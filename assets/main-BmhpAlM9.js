import{d,a as E,R as h,b as u,U as v,I as C}from"./vendor-components-CVNjaD0D.js";import{c as y,w as g,o as S,q as w,b,e as f,u as N,T as A,j as x,k as D,l as L,m as I}from"./vendor-firebase-q4K5YV9j.js";import{A as p,D as s,a as R}from"./vendor-utils-B8p85eXh.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function t(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(a){if(a.ep)return;a.ep=!0;const n=t(a);fetch(a.href,n)}})();class M{constructor(){this.container=null,this.entries=[],this.lastDoc=null,this.hasMore=!1,this.cleanup=()=>{d.unsubscribe("timeEntriesTable")},d.subscribe("timeEntriesTable",this.handleStateChange.bind(this))}handleStateChange(e){(e.filters!==this.currentFilters||e.role!==this.currentRole)&&(this.currentFilters=e.filters,this.currentRole=e.role,this.loadEntries())}async loadEntries(){try{d.setLoading(!0),this.updateLoadingState(!0);const{role:e,user:t,assignedWorkers:r,filters:a}=d.getState();let n=y(E,"timeEntries");const i=[];e===h.ROLES.MANAGER&&r?.length>0&&i.push(g("workerId","in",r)),a.status&&a.status!=="all"&&i.push(g("status","==",a.status)),a.dateRange.startDate&&a.dateRange.endDate&&(i.push(g("date",">=",a.dateRange.startDate)),i.push(g("date","<=",a.dateRange.endDate))),i.push(S("date","desc"));const o=w(n,...i),c=await b(o);this.entries=c.docs.map(l=>({id:l.id,...l.data()})),this.renderEntries()}catch(e){console.error("Failed to load time entries:",e),p.showNotification("Failed to load time entries","error")}finally{d.setLoading(!1),this.updateLoadingState(!1)}}async render(e){if(!e)throw new Error("Container is required");this.container=e;const t=this.createTableStructure();e.appendChild(t),await this.loadEntries()}createTableStructure(){const e=s.createElement("div",{className:"overflow-x-auto"}),t=this.createFiltersSection();e.appendChild(t);const r=s.createElement("table",{className:"min-w-full divide-y divide-gray-200"}),a=s.createElement("thead",{className:"bg-gray-50"});a.appendChild(this.createTableHeader()),r.appendChild(a);const n=s.createElement("tbody",{className:"bg-white divide-y divide-gray-200"});return r.appendChild(n),e.appendChild(r),e}createTableHeader(){const e=s.createElement("tr");return["Date","Worker","Hours","Type","Status","Actions"].forEach(r=>{const a=s.createElement("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",text:r});e.appendChild(a)}),e}createFiltersSection(){const{filters:e}=d.getState(),t=s.createElement("div",{className:"mb-6 p-4 bg-white rounded-lg shadow"}),r=s.createElement("select",{className:"mr-4 px-3 py-2 border rounded"});["All","Pending","Approved","Rejected"].forEach(c=>{const l=s.createElement("option",{text:c,value:c.toLowerCase(),attributes:{selected:e.status===c.toLowerCase()}});r.appendChild(l)});const a=s.createElement("div",{className:"flex items-center space-x-4"}),n=s.createElement("input",{className:"px-3 py-2 border rounded",attributes:{type:"date",value:e.dateRange.startDate?.toISOString().split("T")[0]||""}}),i=s.createElement("input",{className:"px-3 py-2 border rounded",attributes:{type:"date",value:e.dateRange.endDate?.toISOString().split("T")[0]||""}}),o=s.createElement("button",{className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",text:"Apply Filters"});return o.addEventListener("click",()=>{d.updateFilters({status:r.value,dateRange:{startDate:n.value?new Date(n.value):null,endDate:i.value?new Date(i.value):null}})}),a.append(n,i),t.append(r,a,o),t}renderEntries(){const e=this.container.querySelector("tbody");if(!e)return;s.removeAllChildren(e);const{user:t,settings:r}=d.getState();this.entries.forEach(a=>{const n=this.createEntryRow(a,t,r);e.appendChild(n)})}createEntryRow(e,t,r){const a=s.createElement("tr",{className:"hover:bg-gray-50"});a.appendChild(s.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:R.formatDate(new Date(e.date))})),a.appendChild(s.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:e.workerEmail||e.workerId})),a.appendChild(s.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:e.hours.toString()})),a.appendChild(s.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:e.type||"Regular"}));const n=s.createElement("td",{className:"px-6 py-4 whitespace-nowrap"}),i=s.createElement("span",{className:`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${this.getStatusBadgeClass(e.status)}`,text:e.status||"Pending"});n.appendChild(i),a.appendChild(n);const o=s.createElement("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium"});if(h.hasPermission(r,h.PERMISSIONS.APPROVE_TIME))if(e.status==="pending"){const c=s.createElement("button",{className:"text-green-600 hover:text-green-900 mr-4",text:"Approve"});c.addEventListener("click",()=>this.updateStatus(e.id,"approved"));const l=s.createElement("button",{className:"text-red-600 hover:text-red-900",text:"Reject"});l.addEventListener("click",()=>this.updateStatus(e.id,"rejected")),o.append(c,l)}else{const c=s.createElement("button",{className:"text-blue-600 hover:text-blue-900",text:"Reset Status"});c.addEventListener("click",()=>this.updateStatus(e.id,"pending")),o.appendChild(c)}return a.appendChild(o),a}async updateStatus(e,t){try{const{user:r}=d.getState(),a=f(E,"timeEntries",e);await N(a,{status:t,updatedAt:A.now(),updatedBy:r.uid}),await this.loadEntries(),p.showNotification(`Entry ${t} successfully`,"success")}catch(r){console.error("Error updating status:",r),p.showNotification("Failed to update entry status","error")}}getStatusBadgeClass(e){switch(e?.toLowerCase()){case"approved":return"bg-green-100 text-green-800";case"rejected":return"bg-red-100 text-red-800";default:return"bg-yellow-100 text-yellow-800"}}updateLoadingState(e){const t=this.container.querySelector(".loading-overlay");if(e&&!t){const r=s.createElement("div",{className:"loading-overlay"}),a=s.createElement("div",{className:"spinner"});r.appendChild(a),this.container.appendChild(r)}else!e&&t&&t.remove()}destroy(){this.cleanup&&this.cleanup()}}class B{constructor(){this.dashboardState=d,this.userManagement=null,this.timeEntriesTable=null,this.invoiceGenerator=null}async loadUserData(e){try{console.log("Fetching user data for:",e);const t=await x(f(E,"users",e));if(!t.exists()){console.error("No user document found"),this.redirectToLogin();return}const r=t.data();this.dashboardState.setState({user:u.currentUser,role:r.role,assignedWorkers:r.assignedWorkers||[],settings:r.settings||{},isInitialized:!0}),console.log("User role loaded:",r.role),this.renderDashboard()}catch(t){console.error("Error loading user data:",t),this.showError("Failed to load user data. Please refresh the page.")}}renderDashboard(){const e=document.getElementById("adminDashboard");if(!e)throw new Error("Admin dashboard container not found.");s.removeAllChildren(e);const t=s.createElement("div",{className:"bg-white shadow"}),r=this.createHeaderContent();t.appendChild(r),e.appendChild(t);const a=s.createElement("main",{className:"max-w-7xl mx-auto py-6 sm:px-6 lg:px-8"}),n=this.createTimeEntriesSection();a.appendChild(n);const{role:i}=this.dashboardState.getState();if(h.hasAccess(i,["super-admin"])){const o=this.createUserManagementSection(),c=this.createInvoiceSection();a.append(o,c)}e.appendChild(a)}createHeaderContent(){const{user:e}=this.dashboardState.getState(),t=s.createElement("div",{className:"max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex justify-between items-center"}),r=s.createElement("h1",{text:`Welcome, ${e?.email}`,className:"text-3xl font-bold text-gray-900"}),a=s.createElement("button",{text:"Logout",className:"btn-secondary"});return a.addEventListener("click",()=>u.signOut()),t.append(r,a),t}createTimeEntriesSection(){const e=s.createElement("div",{className:"bg-white shadow rounded-lg mb-6"}),t=s.createElement("div",{className:"px-4 py-5 border-b border-gray-200 sm:px-6"}),r=s.createElement("h2",{text:"Time Entries",className:"text-lg font-medium text-gray-900"});t.appendChild(r),e.appendChild(t);const a=s.createElement("div",{id:"timeEntriesContainer",className:"px-4 py-5 sm:p-6"});return e.appendChild(a),this.timeEntriesTable=new M,this.timeEntriesTable.render(a),e}createUserManagementSection(){const e=s.createElement("div",{className:"bg-white shadow rounded-lg mb-6"}),t=s.createElement("div",{className:"px-4 py-5 border-b border-gray-200 sm:px-6"}),r=s.createElement("h2",{text:"User Management",className:"text-lg font-medium text-gray-900"});t.appendChild(r),e.appendChild(t);const a=s.createElement("div",{id:"userManagementContainer",className:"px-4 py-5 sm:p-6"});return e.appendChild(a),this.userManagement=new v("userManagementContainer"),this.userManagement.render(),e}createInvoiceSection(){const e=s.createElement("div",{className:"bg-white shadow rounded-lg"}),t=s.createElement("div",{className:"px-4 py-5 border-b border-gray-200 sm:px-6"}),r=s.createElement("h2",{text:"Invoice Generator",className:"text-lg font-medium text-gray-900"});t.appendChild(r),e.appendChild(t);const a=s.createElement("div",{id:"invoiceGeneratorContainer",className:"px-4 py-5 sm:p-6"});e.appendChild(a);const{companies:n}=this.dashboardState.getState();return this.invoiceGenerator=new C(n),this.invoiceGenerator.render(a),e}redirectToLogin(){console.warn("Redirecting to login..."),window.location.href="/"}showError(e){p.showNotification(e,"error")}}class T{constructor(){this.initialized=!1,this.setupAuthListener()}setupAuthListener(){D(u,async e=>{const t=document.getElementById("appLoading");if(t&&(t.style.display="none"),e)try{await this.loadUserData(e)}catch(r){console.error("Error loading user data:",r),await this.logout()}else d.reset(),window.location.pathname!=="/"&&(window.location.href="/")})}async login(e,t){try{const r=await L(u,e,t),a=await this.loadUserData(r.user);if(!a)throw new Error("No user data found");if(!this.verifyAdminAccess(a.role))throw await this.logout(),new Error("Unauthorized access. Admin privileges required.");return a}catch(r){console.error("Login error:",r);const a=this.getLoginErrorMessage(r);throw p.showNotification(a,"error"),r}}async loadUserData(e){try{let t=null;const r=f(E,"users",e.uid),a=await x(r);if(a.exists())t={id:a.id,...a.data()};else{const n=y(E,"users"),i=w(n,g("email","==",e.email)),o=await b(i);o.empty||(t={id:o.docs[0].id,...o.docs[0].data()})}if(!t)throw new Error("User data not found");return d.updateUserData({user:e,role:t.role,assignedWorkers:t.assignedWorkers||[],settings:t.settings||h.getDefaultPermissions(t.role)}),this.updateUIForAuthenticatedUser(e.email),t}catch(t){throw console.error("Error loading user data:",t),t}}verifyAdminAccess(e){return[h.ROLES.SUPER_ADMIN,h.ROLES.MANAGER].includes(e)}async logout(){try{await I(u),d.reset(),this.redirectToLogin()}catch(e){console.error("Logout error:",e),p.showNotification("Failed to logout. Please try again.","error")}}updateUIForAuthenticatedUser(e){const t=document.getElementById("authContainer"),r=document.getElementById("adminDashboard"),a=document.getElementById("adminEmail");t&&t.classList.remove("active"),r&&(r.style.display="block"),a&&(a.textContent=e)}getLoginErrorMessage(e){switch(e.code){case"auth/invalid-email":return"Invalid email address format.";case"auth/user-disabled":return"This account has been disabled. Please contact support.";case"auth/user-not-found":return"No account found with this email.";case"auth/wrong-password":return"Invalid password.";case"auth/too-many-requests":return"Too many failed attempts. Please try again later.";default:return e.message||"An error occurred during login."}}redirectToLogin(){console.warn("Redirecting to login..."),window.location.href="./"}async verifySession(){const e=u.currentUser;if(!e)return!1;try{return await e.getIdToken(!0),!0}catch(t){return console.error("Session verification failed:",t),!1}}getAuthStatus(){const{user:e,role:t,isInitialized:r}=d.getState();return{isAuthenticated:!!e,isAdmin:this.verifyAdminAccess(t),isInitialized:r,user:e}}}class U{constructor(){this.adminDashboard=null,this.authManager=new T}async initialize(){try{console.log("Initializing Admin App..."),this.setupEventListeners(),this.setupAuthStateListener(),this.setupErrorHandling()}catch(e){console.error("Failed to initialize admin app:",e),this.showError("Application initialization failed.")}}setupEventListeners(){const e=document.getElementById("loginForm");e&&e.addEventListener("submit",async r=>{r.preventDefault();const a=document.getElementById("email").value,n=document.getElementById("password").value;try{await this.authManager.login(a,n)}catch{}});const t=document.getElementById("logoutBtn");t&&t.addEventListener("click",()=>this.authManager.logout())}setupAuthStateListener(){u.onAuthStateChanged(async e=>{const t=document.getElementById("appLoading");t&&(t.style.display="none"),e?(console.log("User authenticated:",e.email),await this.initializeDashboard(e)):(document.getElementById("adminDashboard").style.display="none",document.getElementById("authContainer").classList.add("active"))})}async initializeDashboard(e){try{this.adminDashboard=new B,await this.adminDashboard.initialize()}catch(t){console.error("Failed to initialize dashboard:",t),this.showError("Failed to initialize dashboard.")}}setupErrorHandling(){window.addEventListener("unhandledrejection",e=>{console.error("Unhandled promise rejection:",e.reason),this.showError("An unexpected error occurred.")}),window.addEventListener("error",e=>{console.error("Global error:",e.error),this.showError("An unexpected error occurred.")})}showError(e){const t=document.getElementById("errorBoundary"),r=document.getElementById("errorMessage");t&&r&&(t.style.display="flex",r.textContent=e)}}document.addEventListener("DOMContentLoaded",()=>{new U().initialize()});
