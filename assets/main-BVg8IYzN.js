import{d as i,a as g,R as c,b as u,U as C,I as S}from"./vendor-components-Df6vKdQT.js";import{c as w,w as p,o as N,q as b,b as v,e as y,u as D,T as A,j as x,k as L,l as I,m as R}from"./vendor-firebase-q4K5YV9j.js";import{D as r,A as h,a as B}from"./vendor-utils-B8p85eXh.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function n(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(t){if(t.ep)return;t.ep=!0;const s=n(t);fetch(t.href,s)}})();class f{constructor(e){this.container=e,this.entries=[],this.lastDoc=null,this.hasMore=!1,i.subscribe("timeEntriesTable",this.handleStateChange.bind(this))}handleStateChange(e){(e.filters!==this.currentFilters||e.role!==this.currentRole)&&(this.currentFilters=e.filters,this.currentRole=e.role,this.loadEntries())}createTimeEntriesSection(){const e=r.createElement("div",{className:"bg-white shadow rounded-lg mb-6"}),n=r.createElement("div",{id:"timeEntriesContainer",className:"px-4 py-5 sm:p-6"}),a=r.createElement("div",{className:"px-4 py-5 border-b border-gray-200 sm:px-6"}),t=r.createElement("h2",{text:"Time Entries",className:"text-lg font-medium text-gray-900"});return a.appendChild(t),e.appendChild(a),e.appendChild(n),this.timeEntriesTable=new f(n),this.timeEntriesTable.render(n),e}async loadEntries(){try{i.setLoading(!0),this.updateLoadingState(!0);const{role:e,user:n,assignedWorkers:a,filters:t}=i.getState();let s=w(g,"timeEntries");const o=[];e===c.ROLES.MANAGER&&a?.length>0&&o.push(p("workerId","in",a)),t.status&&t.status!=="all"&&o.push(p("status","==",t.status)),t.dateRange.startDate&&t.dateRange.endDate&&(o.push(p("date",">=",t.dateRange.startDate)),o.push(p("date","<=",t.dateRange.endDate))),o.push(N("date","desc"));const d=b(s,...o),l=await v(d);this.entries=l.docs.map(m=>({id:m.id,...m.data()})),this.renderEntries()}catch(e){console.error("Failed to load time entries:",e),h.showNotification("Failed to load time entries","error")}finally{i.setLoading(!1),this.updateLoadingState(!1)}}async render(){if(!this.container)throw new Error("Container not found");const e=this.createTableStructure();this.container.appendChild(e),await this.loadEntries()}createTableStructure(){const e=r.createElement("div",{className:"overflow-x-auto"}),n=this.createFiltersSection();e.appendChild(n);const a=r.createElement("table",{className:"min-w-full divide-y divide-gray-200"}),t=r.createElement("thead",{className:"bg-gray-50"});t.appendChild(this.createTableHeader()),a.appendChild(t);const s=r.createElement("tbody",{className:"bg-white divide-y divide-gray-200"});return a.appendChild(s),e.appendChild(a),e}createTableHeader(){const e=r.createElement("tr");return["Date","Worker","Hours","Type","Status","Actions"].forEach(a=>{const t=r.createElement("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",text:a});e.appendChild(t)}),e}createFiltersSection(){const{filters:e}=i.getState(),n=r.createElement("div",{className:"mb-6 p-4 bg-white rounded-lg shadow"}),a=r.createElement("select",{className:"mr-4 px-3 py-2 border rounded"});["All","Pending","Approved","Rejected"].forEach(l=>{const m=r.createElement("option",{text:l,value:l.toLowerCase(),attributes:{selected:e.status===l.toLowerCase()}});a.appendChild(m)});const t=r.createElement("div",{className:"flex items-center space-x-4"}),s=r.createElement("input",{className:"px-3 py-2 border rounded",attributes:{type:"date",value:e.dateRange.startDate?.toISOString().split("T")[0]||""}}),o=r.createElement("input",{className:"px-3 py-2 border rounded",attributes:{type:"date",value:e.dateRange.endDate?.toISOString().split("T")[0]||""}}),d=r.createElement("button",{className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",text:"Apply Filters"});return d.addEventListener("click",()=>{i.updateFilters({status:a.value,dateRange:{startDate:s.value?new Date(s.value):null,endDate:o.value?new Date(o.value):null}})}),t.append(s,o),n.append(a,t,d),n}renderEntries(){const e=this.container.querySelector("tbody");if(!e)return;r.removeAllChildren(e);const{user:n,settings:a}=i.getState();this.entries.forEach(t=>{const s=this.createEntryRow(t,n,a);e.appendChild(s)})}createEntryRow(e,n,a){const t=r.createElement("tr",{className:"hover:bg-gray-50"});t.appendChild(r.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:B.formatDate(new Date(e.date))})),t.appendChild(r.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:e.workerEmail||e.workerId})),t.appendChild(r.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:e.hours.toString()})),t.appendChild(r.createElement("td",{className:"px-6 py-4 whitespace-nowrap",text:e.type||"Regular"}));const s=r.createElement("td",{className:"px-6 py-4 whitespace-nowrap"}),o=r.createElement("span",{className:`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${this.getStatusBadgeClass(e.status)}`,text:e.status||"Pending"});s.appendChild(o),t.appendChild(s);const d=r.createElement("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium"});if(c.hasPermission(a,c.PERMISSIONS.APPROVE_TIME))if(e.status==="pending"){const l=r.createElement("button",{className:"text-green-600 hover:text-green-900 mr-4",text:"Approve"});l.addEventListener("click",()=>this.updateStatus(e.id,"approved"));const m=r.createElement("button",{className:"text-red-600 hover:text-red-900",text:"Reject"});m.addEventListener("click",()=>this.updateStatus(e.id,"rejected")),d.append(l,m)}else{const l=r.createElement("button",{className:"text-blue-600 hover:text-blue-900",text:"Reset Status"});l.addEventListener("click",()=>this.updateStatus(e.id,"pending")),d.appendChild(l)}return t.appendChild(d),t}async updateStatus(e,n){try{const{user:a}=i.getState(),t=y(g,"timeEntries",e);await D(t,{status:n,updatedAt:A.now(),updatedBy:a.uid}),await this.loadEntries(),h.showNotification(`Entry ${n} successfully`,"success")}catch(a){console.error("Error updating status:",a),h.showNotification("Failed to update entry status","error")}}getStatusBadgeClass(e){switch(e?.toLowerCase()){case"approved":return"bg-green-100 text-green-800";case"rejected":return"bg-red-100 text-red-800";default:return"bg-yellow-100 text-yellow-800"}}updateLoadingState(e){if(!this.container)return;const n=this.container.querySelector(".loading-overlay");if(e&&!n){const a=r.createElement("div",{className:"loading-overlay"}),t=r.createElement("div",{className:"spinner"});a.appendChild(t),this.container.appendChild(a)}else!e&&n&&n.remove()}destroy(){this.cleanup&&this.cleanup()}}class U{constructor(){this.dashboardState=i,this.components={userManagement:null,timeEntriesTable:null,invoiceGenerator:null},this.initialize=this.initialize.bind(this),this.loadUserData=this.loadUserData.bind(this),this.renderDashboard=this.renderDashboard.bind(this)}async initialize(){try{console.log("Initializing AdminDashboard...");const e=u.currentUser;if(!e)throw console.error("No authenticated user"),new Error("No authenticated user");return await this.loadUserData(e.uid),await this.renderDashboard(),!0}catch(e){throw console.error("Failed to initialize dashboard:",e),e}}async loadUserData(e){try{console.log("Fetching user data for:",e);const n=await x(y(g,"users",e));if(!n.exists())throw console.error("No user document found"),new Error("User document not found");const a=n.data();this.dashboardState.setState({user:u.currentUser,role:a.role,assignedWorkers:a.assignedWorkers||[],settings:a.settings||{},isInitialized:!0}),console.log("User role loaded:",a.role)}catch(n){throw console.error("Error loading user data:",n),h.showNotification("Failed to load user data","error"),n}}async renderDashboard(){console.log("Rendering dashboard...");const e=document.getElementById("adminDashboard");if(!e)throw new Error("Admin dashboard container not found");r.removeAllChildren(e);const n=this.createHeader(),a=r.createElement("main",{className:"max-w-7xl mx-auto py-6 sm:px-6 lg:px-8"});e.appendChild(n),e.appendChild(a);const{role:t}=this.dashboardState.getState();console.log("Current user role:",t),c.hasAccess(t,[c.ROLES.SUPER_ADMIN,c.ROLES.MANAGER])&&await this.renderAdminSections(a)}createHeader(){const e=r.createElement("header",{className:"bg-white shadow"}),{user:n}=this.dashboardState.getState(),a=r.createElement("div",{className:"max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex justify-between items-center"}),t=r.createElement("h1",{text:`Welcome, ${n?.email}`,className:"text-3xl font-bold text-gray-900"}),s=r.createElement("button",{text:"Logout",className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"});return s.addEventListener("click",()=>u.signOut()),a.append(t,s),e.appendChild(a),e}async renderAdminSections(e){try{console.log("Rendering admin sections...");const n={userManagement:this.createSection("User Management","userManagementContent"),timeEntries:this.createSection("Time Entries","timeEntriesContent"),invoices:this.createSection("Invoice Generator","invoiceGeneratorContent")};Object.values(n).forEach(o=>{e.appendChild(o)});const a=document.getElementById("userManagementContent"),t=document.getElementById("timeEntriesContent"),s=document.getElementById("invoiceGeneratorContent");if(a&&(console.log("Initializing UserManagement component..."),this.components.userManagement=new C(a)),t&&(console.log("Initializing TimeEntriesTable component..."),this.components.timeEntriesTable=new f(t),await this.components.timeEntriesTable.render()),s){console.log("Initializing InvoiceGenerator component...");const{companies:o=[]}=this.dashboardState.getState();this.components.invoiceGenerator=new S(o),this.components.invoiceGenerator.render(s)}}catch(n){console.error("Error rendering admin sections:",n),h.showNotification("Failed to render dashboard sections","error")}}createSection(e,n){const a=r.createElement("div",{className:"bg-white shadow rounded-lg mb-6"}),t=r.createElement("div",{className:"px-4 py-5 border-b border-gray-200 sm:px-6"}),s=r.createElement("h2",{text:e,className:"text-lg font-medium text-gray-900"}),o=r.createElement("div",{id:n,className:"px-4 py-5 sm:p-6"});return t.appendChild(s),a.appendChild(t),a.appendChild(o),a}getContentElements(e){return{userManagementContent:document.getElementById("userManagementContent"),timeEntriesContent:document.getElementById("timeEntriesContent"),invoiceGeneratorContent:document.getElementById("invoiceGeneratorContent")}}redirectToLogin(){console.warn("Redirecting to login..."),window.location.href="/"}showError(e){h.showNotification(e,"error")}}class M{constructor(){this.initialized=!1,this.setupAuthListener()}setupAuthListener(){console.log("Setting up auth listener..."),L(u,async e=>{console.log("Auth state changed:",e?"User logged in":"No user");const n=document.getElementById("appLoading"),a=document.getElementById("authContainer"),t=document.getElementById("adminDashboard");if(n&&(n.style.display="none",console.log("Loading screen hidden")),e)try{if(console.log("Loading user data..."),!await this.loadUserData(e))throw new Error("No user data found");a&&(a.classList.remove("active"),a.style.display="none"),t&&(t.style.display="block")}catch(s){console.error("Error loading user data:",s),await this.logout()}else a&&(a.style.display="block",a.classList.add("active")),t&&(t.style.display="none"),console.log("No user, showing login form")})}async login(e,n){try{console.log("Attempting login...");const a=await I(u,e,n);console.log("Firebase Auth successful, loading user data...");const t=await this.loadUserData(a.user);if(!t)throw console.error("No user data found"),new Error("No user data found");if(console.log("Verifying admin access...",t.role),!this.verifyAdminAccess(t.role))throw console.error("User does not have admin access"),await this.logout(),new Error("Unauthorized access. Admin privileges required.");return console.log("Login successful!"),t}catch(a){console.error("Login error:",a);const t=this.getLoginErrorMessage(a);throw h.showNotification(t,"error"),a}}async loadUserData(e){try{let n=null;const a=y(g,"users",e.uid),t=await x(a);if(t.exists())n={id:t.id,...t.data()};else{const s=w(g,"users"),o=b(s,p("email","==",e.email)),d=await v(o);d.empty||(n={id:d.docs[0].id,...d.docs[0].data()})}if(!n)throw new Error("User data not found");return i.updateUserData({user:e,role:n.role,assignedWorkers:n.assignedWorkers||[],settings:n.settings||c.getDefaultPermissions(n.role)}),this.updateUIForAuthenticatedUser(e.email),n}catch(n){throw console.error("Error loading user data:",n),n}}verifyAdminAccess(e){return[c.ROLES.SUPER_ADMIN,c.ROLES.MANAGER].includes(e)}async logout(){try{await R(u),i.reset(),this.redirectToLogin()}catch(e){console.error("Logout error:",e),h.showNotification("Failed to logout. Please try again.","error")}}updateUIForAuthenticatedUser(e){const n=document.getElementById("authContainer"),a=document.getElementById("adminDashboard"),t=document.getElementById("adminEmail");n&&n.classList.remove("active"),a&&(a.style.display="block"),t&&(t.textContent=e)}getLoginErrorMessage(e){switch(e.code){case"auth/invalid-email":return"Invalid email address format.";case"auth/user-disabled":return"This account has been disabled. Please contact support.";case"auth/user-not-found":return"No account found with this email.";case"auth/wrong-password":return"Invalid password.";case"auth/too-many-requests":return"Too many failed attempts. Please try again later.";default:return e.message||"An error occurred during login."}}redirectToLogin(){console.warn("Redirecting to login..."),window.location.href="./"}async verifySession(){const e=u.currentUser;if(!e)return!1;try{return await e.getIdToken(!0),!0}catch(n){return console.error("Session verification failed:",n),!1}}getAuthStatus(){const{user:e,role:n,isInitialized:a}=i.getState();return{isAuthenticated:!!e,isAdmin:this.verifyAdminAccess(n),isInitialized:a,user:e}}}if(!i)throw console.error("DashboardState not initialized"),new Error("DashboardState not initialized");class T{constructor(){this.adminDashboard=null,this.authManager=new M}async initialize(){try{console.log("Initializing Admin App..."),this.setupEventListeners(),this.setupAuthStateListener(),this.setupErrorHandling()}catch(e){console.error("Failed to initialize admin app:",e),this.showError("Application initialization failed.")}}setupAuthStateListener(){u.onAuthStateChanged(async e=>{console.log("Auth state changed:",e?"User authenticated":"No user");const n=document.getElementById("appLoading"),a=document.getElementById("authContainer"),t=document.getElementById("adminDashboard");n&&(n.style.display="none"),e?(console.log("User authenticated:",e.email),a&&(a.style.display="none"),t&&(t.style.display="block"),await this.initializeDashboard(e)):(console.log("No user, showing login form"),a&&(a.style.display="block"),t&&(t.style.display="none"))})}setupEventListeners(){const e=document.getElementById("loginForm");e&&e.addEventListener("submit",async a=>{a.preventDefault();const t=document.getElementById("email").value,s=document.getElementById("password").value;try{await this.authManager.login(t,s)}catch{}});const n=document.getElementById("logoutBtn");n&&n.addEventListener("click",()=>this.authManager.logout())}async initializeDashboard(e){try{this.adminDashboard=new U,await this.adminDashboard.initialize()}catch(n){console.error("Failed to initialize dashboard:",n),this.showError("Failed to initialize dashboard.")}}setupErrorHandling(){window.addEventListener("unhandledrejection",e=>{console.error("Unhandled promise rejection:",e.reason),this.showError("An unexpected error occurred.")}),window.addEventListener("error",e=>{console.error("Global error:",e.error),this.showError("An unexpected error occurred.")})}showError(e){const n=document.getElementById("errorBoundary"),a=document.getElementById("errorMessage");n&&a&&(n.style.display="flex",a.textContent=e)}}document.addEventListener("DOMContentLoaded",()=>{new T().initialize()});
