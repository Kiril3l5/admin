import{d as l,a as u,b as h,R as m,U as C,I as S}from"./vendor-components-CEecRQ_9.js";import{e as p,u as f,T as E,c as w,w as b,q as v,b as x,j as A,o as N,k as D,l as L}from"./vendor-firebase-Ciht_zlW.js";import{D as o,A as c}from"./vendor-utils-lm0uXl8i.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function t(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=t(n);fetch(n.href,a)}})();class B{constructor(e){this.container=e,this.entries=[],this.selectedEntries=new Set,this.render(),l.subscribe("timeEntriesTable",t=>{this.handleStateChange(t)})}createTableStructure(){const e=o.createElement("div",{className:"overflow-x-auto bg-white rounded-lg shadow"}),t=o.createElement("div",{className:"p-4 border-b flex justify-between items-center"}),r=o.createElement("h2",{className:"text-lg font-semibold",text:"Time Entries"}),n=o.createElement("div",{className:"flex gap-2",attributes:{id:"batchActions"}});t.append(r,n),e.appendChild(t);const a=this.createFiltersSection();e.appendChild(a);const s=o.createElement("table",{className:"min-w-full divide-y divide-gray-200"}),i=o.createElement("thead",{className:"bg-gray-50"});i.appendChild(this.createTableHeader()),s.appendChild(i);const d=o.createElement("tbody",{className:"bg-white divide-y divide-gray-200",attributes:{id:"timeEntriesBody"}});return s.appendChild(d),e.appendChild(s),e}createTableHeader(){const e=o.createElement("tr"),t=o.createElement("th",{className:"px-6 py-3 w-8"}),r=o.createElement("input",{attributes:{type:"checkbox",id:"selectAll"}});r.addEventListener("change",s=>this.handleSelectAll(s)),t.appendChild(r);const a=["Worker","Date","Hours","Type","Status","Actions"].map(s=>o.createElement("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",text:s}));return e.append(t,...a),e}createEntryRow(e){const t=o.createElement("tr",{className:"hover:bg-gray-50"}),r=o.createElement("td",{className:"px-6 py-4 w-8"}),n=o.createElement("input",{attributes:{type:"checkbox","data-entry-id":e.id}});n.addEventListener("change",()=>this.handleSelectEntry(e.id)),r.appendChild(n);const s=[{text:e.workerName||e.workerId},{text:new Date(e.date).toLocaleDateString()},{text:e.hours.toString()},{text:e.type||"Regular"},{content:this.createStatusBadge(e.status)},{content:this.createActionButtons(e)}].map(({text:i,content:d})=>{const y=o.createElement("td",{className:"px-6 py-4 whitespace-nowrap"});return i?y.textContent=i:d&&y.appendChild(d),y});return t.append(r,...s),t}createStatusBadge(e){const t={pending:"bg-yellow-100 text-yellow-800",approved:"bg-green-100 text-green-800",rejected:"bg-red-100 text-red-800"};return o.createElement("span",{className:`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${t[e]||t.pending}`,text:e})}createActionButtons(e){const t=o.createElement("div",{className:"flex justify-end gap-2"});if(e.status==="pending"){const r=o.createElement("button",{className:"bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600",text:"Approve"});r.addEventListener("click",()=>this.handleApprove([e.id]));const n=o.createElement("button",{className:"bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600",text:"Reject"});n.addEventListener("click",()=>this.handleReject([e.id])),t.append(r,n)}return t}updateBatchActions(){const e=document.getElementById("batchActions");if(e&&(o.removeAllChildren(e),this.selectedEntries.size>0)){const t=o.createElement("button",{className:"bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600",text:`Approve Selected (${this.selectedEntries.size})`});t.addEventListener("click",()=>this.handleApprove(Array.from(this.selectedEntries)));const r=o.createElement("button",{className:"bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600",text:`Reject Selected (${this.selectedEntries.size})`});r.addEventListener("click",()=>this.handleReject(Array.from(this.selectedEntries))),e.append(t,r)}}async handleApprove(e){try{for(const t of e){const r=p(u,"timeEntries",t);await f(r,{status:"approved",approvedAt:E.now(),approvedBy:l.getState().user.uid})}await this.loadEntries(),c.showNotification(`${e.length} entries approved`,"success"),this.selectedEntries.clear(),this.updateBatchActions()}catch(t){console.error("Error approving entries:",t),c.showNotification("Failed to approve entries","error")}}async handleReject(e){try{for(const t of e){const r=p(u,"timeEntries",t);await f(r,{status:"rejected",rejectedAt:E.now(),rejectedBy:l.getState().user.uid})}await this.loadEntries(),c.showNotification(`${e.length} entries rejected`,"error"),this.selectedEntries.clear(),this.updateBatchActions()}catch(t){console.error("Error rejecting entries:",t),c.showNotification("Failed to reject entries","error")}}async render(){try{if(!this.container)return;o.removeAllChildren(this.container);const e=this.createTableStructure();this.container.appendChild(e),await this.loadEntries()}catch(e){console.error("Error rendering time entries table:",e),c.showNotification("Failed to render time entries","error")}}async loadEntries(){try{l.setLoading(!0);const{role:e,assignedWorkers:t}=l.getState();let r=w(u,"timeEntries"),n=[];t?.length>0&&n.push(b("workerId","in",t));const a=v(r,...n),s=await x(a);this.entries=s.docs.map(d=>({id:d.id,...d.data()}));const i=document.getElementById("timeEntriesBody");i&&(o.removeAllChildren(i),this.entries.forEach(d=>{i.appendChild(this.createEntryRow(d))}))}catch(e){console.error("Error loading time entries:",e),c.showNotification("Failed to load time entries","error")}finally{l.setLoading(!1)}}}class I{constructor(){this.dashboardState=l,this.components={userManagement:null,timeEntriesTable:null,invoiceGenerator:null},this.initialize=this.initialize.bind(this),this.loadUserData=this.loadUserData.bind(this),this.renderDashboard=this.renderDashboard.bind(this)}async initialize(){try{console.log("Initializing AdminDashboard...");const e=h.currentUser;if(!e)throw console.error("No authenticated user"),new Error("No authenticated user");return await this.loadUserData(e.uid),await this.renderDashboard(),!0}catch(e){throw console.error("Failed to initialize dashboard:",e),e}}async loadUserData(e){try{console.log("Fetching user data for:",e);const t=await A(p(u,"users",e));if(!t.exists())throw console.error("No user document found"),new Error("User document not found");const r=t.data();this.dashboardState.setState({user:h.currentUser,role:r.role,assignedWorkers:r.assignedWorkers||[],settings:r.settings||{},isInitialized:!0}),console.log("User role loaded:",r.role)}catch(t){throw console.error("Error loading user data:",t),c.showNotification("Failed to load user data","error"),t}}async renderDashboard(){console.log("Rendering dashboard...");const e=document.getElementById("adminDashboard");if(!e)throw new Error("Admin dashboard container not found");e.style.display="block",o.removeAllChildren(e);const t=this.createHeader(),r=o.createElement("main",{className:"max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8"});e.appendChild(t),e.appendChild(r);const{role:n}=this.dashboardState.getState();console.log("Current user role:",n),m.hasAccess(n,[m.ROLES.SUPER_ADMIN,m.ROLES.MANAGER])&&await this.renderAdminSections(r)}createHeader(){const e=o.createElement("header",{className:"bg-white shadow mb-6"}),{user:t}=this.dashboardState.getState(),r=o.createElement("div",{className:"max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex justify-between items-center"}),n=o.createElement("h1",{text:`Welcome, ${t?.email}`,className:"text-3xl font-bold text-gray-900"}),a=o.createElement("button",{text:"Logout",className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"});return a.addEventListener("click",async()=>{try{await h.signOut(),window.location.reload()}catch(s){console.error("Error signing out:",s),c.showNotification("Failed to sign out","error")}}),r.append(n,a),e.appendChild(r),e}async renderAdminSections(e){try{console.log("Rendering admin sections...");const t=this.createSection("User Management","userManagementContent"),r=t.querySelector('[id="userManagementContent"]');r&&(this.components.userManagement=new C(r)),e.appendChild(t);const n=this.createSection("Time Entries","timeEntriesContent"),a=n.querySelector('[id="timeEntriesContent"]');a&&(this.components.timeEntriesTable=new B(a)),e.appendChild(n);const s=this.createSection("Invoice Generator","invoiceGeneratorContent"),i=s.querySelector('[id="invoiceGeneratorContent"]');if(i){const{companies:d=[]}=this.dashboardState.getState();this.components.invoiceGenerator=new S(d),this.components.invoiceGenerator.render(i)}e.appendChild(s)}catch(t){console.error("Error rendering admin sections:",t),c.showNotification("Failed to render dashboard sections","error")}}createSection(e,t){console.log(`Creating section: ${e}`);const r=o.createElement("div",{className:"bg-white shadow rounded-lg mb-6"}),n=o.createElement("div",{className:"px-4 py-5 border-b border-gray-200 sm:px-6"}),a=o.createElement("h2",{text:e,className:"text-lg font-medium text-gray-900"}),s=o.createElement("div",{attributes:{id:t},className:"px-4 py-5 sm:p-6 section-content"});return n.appendChild(a),r.appendChild(n),r.appendChild(s),r}getContentElements(e){return{userManagementContent:document.getElementById("userManagementContent"),timeEntriesContent:document.getElementById("timeEntriesContent"),invoiceGeneratorContent:document.getElementById("invoiceGeneratorContent")}}redirectToLogin(){console.warn("Redirecting to login..."),window.location.href="/"}showError(e){c.showNotification(e,"error")}}class U{constructor(){this.initialized=!1,this.setupAuthListener()}setupAuthListener(){N(h,async e=>{console.log("Auth: ",e?"User authenticated":"No user");const t=document.getElementById("appLoading"),r=document.getElementById("authContainer"),n=document.getElementById("adminDashboard");if(t&&(t.style.display="none",console.log("Loading screen hidden")),e)try{if(console.log("Loading user data..."),!await this.loadUserData(e))throw new Error("No user data found");r&&(r.classList.remove("active"),r.style.display="none"),n&&(n.style.display="block")}catch(a){console.error("Error loading user data:",a),await this.logout()}else r&&(r.style.display="block",r.classList.add("active")),n&&(n.style.display="none"),console.log("No user, showing login form")})}async login(e,t){try{console.log("Attempting login...");const r=await D(h,e,t);console.log("Firebase Auth successful, loading user data...");const n=await this.loadUserData(r.user);if(!n)throw console.error("No user data found"),new Error("No user data found");if(console.log("Verifying admin access...",n.role),!this.verifyAdminAccess(n.role))throw console.error("User does not have admin access"),await this.logout(),new Error("Unauthorized access. Admin privileges required.");return console.log("Login successful!"),n}catch(r){console.error("Login error:",r);const n=this.getLoginErrorMessage(r);throw c.showNotification(n,"error"),r}}async loadUserData(e){try{let t=null;const r=p(u,"users",e.uid),n=await A(r);if(n.exists())t={id:n.id,...n.data()};else{const a=w(u,"users"),s=v(a,b("email","==",e.email)),i=await x(s);i.empty||(t={id:i.docs[0].id,...i.docs[0].data()})}if(!t)throw new Error("User data not found");return l.updateUserData({user:e,role:t.role,assignedWorkers:t.assignedWorkers||[],settings:t.settings||m.getDefaultPermissions(t.role)}),this.updateUIForAuthenticatedUser(e.email),t}catch(t){throw console.error("Error loading user data:",t),t}}verifyAdminAccess(e){return[m.ROLES.SUPER_ADMIN,m.ROLES.MANAGER].includes(e)}async logout(){try{await L(h),l.reset(),this.redirectToLogin()}catch(e){console.error("Logout error:",e),c.showNotification("Failed to logout. Please try again.","error")}}updateUIForAuthenticatedUser(e){const t=document.getElementById("authContainer"),r=document.getElementById("adminDashboard"),n=document.getElementById("adminEmail");t&&t.classList.remove("active"),r&&(r.style.display="block"),n&&(n.textContent=e)}getLoginErrorMessage(e){switch(e.code){case"auth/invalid-email":return"Invalid email address format.";case"auth/user-disabled":return"This account has been disabled. Please contact support.";case"auth/user-not-found":return"No account found with this email.";case"auth/wrong-password":return"Invalid password.";case"auth/too-many-requests":return"Too many failed attempts. Please try again later.";default:return e.message||"An error occurred during login."}}redirectToLogin(){console.warn("Redirecting to login..."),window.location.href="./"}async verifySession(){const e=h.currentUser;if(!e)return!1;try{return await e.getIdToken(!0),!0}catch(t){return console.error("Session verification failed:",t),!1}}getAuthStatus(){const{user:e,role:t,isInitialized:r}=l.getState();return{isAuthenticated:!!e,isAdmin:this.verifyAdminAccess(t),isInitialized:r,user:e}}}if(!l)throw console.error("DashboardState not initialized"),new Error("DashboardState not initialized");class M{constructor(){this.adminDashboard=null,this.authManager=new U}async initialize(){try{console.log("Initializing Admin App..."),this.setupEventListeners(),this.setupAuthStateListener(),this.setupErrorHandling()}catch(e){console.error("Failed to initialize admin app:",e),this.showError("Application initialization failed.")}}setupAuthStateListener(){h.onAuthStateChanged(async e=>{console.log("Auth state changed:",e?"User authenticated":"No user");const t=document.getElementById("appLoading"),r=document.getElementById("authContainer"),n=document.getElementById("adminDashboard");t&&(t.style.display="none"),e?(console.log("User authenticated:",e.email),r&&(r.style.display="none"),n&&(n.style.display="block"),await this.initializeDashboard(e)):(console.log("No user, showing login form"),r&&(r.style.display="block"),n&&(n.style.display="none"))})}setupEventListeners(){const e=document.getElementById("loginForm");e&&e.addEventListener("submit",async r=>{r.preventDefault();const n=document.getElementById("email").value,a=document.getElementById("password").value;try{await this.authManager.login(n,a)}catch{}});const t=document.getElementById("logoutBtn");t&&t.addEventListener("click",()=>this.authManager.logout())}async initializeDashboard(e){try{this.adminDashboard=new I,await this.adminDashboard.initialize()}catch(t){console.error("Failed to initialize dashboard:",t),this.showError("Failed to initialize dashboard.")}}setupErrorHandling(){window.addEventListener("unhandledrejection",e=>{console.error("Unhandled promise rejection:",e.reason),this.showError("An unexpected error occurred.")}),window.addEventListener("error",e=>{console.error("Global error:",e.error),this.showError("An unexpected error occurred.")})}showError(e){const t=document.getElementById("errorBoundary"),r=document.getElementById("errorMessage");t&&r&&(t.style.display="flex",r.textContent=e)}}document.addEventListener("DOMContentLoaded",()=>{new M().initialize()});
